<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bergen busstasjon — All departures (robust)</title>
<style>
  :root{ --bg:#fff; --card:#f7f8fb; --text:#0b1220; --muted:#5a6778; --accent:#f97316; --border:#e6eaf0; --bad:#dc2626; }
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:1280px;margin:40px auto;padding:0 18px}
  h1{margin:0 0 10px;font-size:clamp(24px,3vw,38px);font-weight:800}.accent{color:var(--accent)}
  .badge{display:inline-flex;gap:.6rem;align-items:center;background:var(--card);border:1px solid var(--border);color:var(--muted);padding:.5rem .9rem;border-radius:999px;font-size:.88rem;font-weight:600;margin-bottom:16px}
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;margin:10px 0 18px}
  .chip{display:inline-flex;align-items:center;gap:.56rem;background:var(--card);border:1px solid var(--border);padding:.5rem .85rem;border-radius:999px;font-weight:600}
  .chip input{appearance:none;width:16px;height:16px;border-radius:6px;border:2px solid var(--accent)} .chip input:checked{background:var(--accent)}
  .search{min-width:260px;flex:1 1 280px;background:#fff;border:1px solid var(--border);padding:.65rem .85rem;border-radius:12px}
  #status{color:var(--muted);font-size:.95rem;margin:8px 0}
  .table{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 8px 24px rgba(17,24,39,.06)}
  .thead,.trow{display:grid;grid-template-columns:94px 76px 100px 1fr 180px 110px;align-items:center}
  .thead{background:var(--card);color:var(--muted);font-weight:700;border-bottom:1px solid var(--border)}
  .cell{padding:12px 16px;border-bottom:1px dashed var(--border)} .trow:last-child .cell{border-bottom:none}
  .line-pill{display:inline-flex;align-items:center;gap:.45rem;padding:.12rem .52rem;border-radius:8px;border:1px solid var(--accent);color:var(--accent);background:rgba(249,115,22,.08);font-weight:800}
  .footer{display:flex;justify-content:space-between;gap:1rem;align-items:center;color:var(--muted);margin:10px 2px 0}
  .err{color:var(--bad);margin:8px 0;font-weight:700}
  .debug{margin-top:10px;font-size:.88rem;color:#334155;background:#fff;border:1px dashed var(--border);border-radius:12px;padding:8px 10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Bergen busstasjon — <span class="accent">All departures</span></h1>
  <div class="badge">Robust mode • Multiple API strategies • Refresh 15s</div>

  <div class="controls">
    <label class="chip"><input id="busToggle" type="checkbox" checked /> Bus</label>
    <label class="chip"><input id="tramToggle" type="checkbox" checked /> Bybanen</label>
    <input id="exactFilter" class="search" placeholder="Optional exact line filter (comma): e.g. 1, 2, 50E, 600" />
  </div>

  <div id="status">Initializing…</div>
  <div id="error" class="err" style="display:none"></div>

  <div class="table">
    <div class="thead">
      <div class="cell">Time</div><div class="cell">In</div><div class="cell">Line</div>
      <div class="cell">Destination</div><div class="cell">Stop</div><div class="cell">Mode</div>
    </div>
    <div id="rows"></div>
  </div>

  <div class="debug" id="debug" style="display:none"></div>

  <div class="footer">
    <div>Source: Entur realtime</div>
    <div>Last update: <span id="ts">—</span></div>
  </div>
</div>

<script>
const CLIENT = "bergen-board/robust (contact: you@example.com)";
const GP_V3 = "https://api.entur.io/journey-planner/v3/graphql";
const GP_V2 = "https://api.entur.org/journeyplanner/2.0/index/graphql";
const ENDPOINTS = [GP_V3, GP_V2];
const FALLBACK_STOP_IDS=["NSR:StopPlace:30810","NSR:StopPlace:62356","NSR:StopPlace:62129"];
const REFRESH_MS=15000, RANGE_SECONDS=6*3600, PER_FETCH=120;

const $=s=>document.querySelector(s);
const pad2=n=>(n<10?"0"+n:""+n);
const fmt=d=>{const t=new Date(d);return `${pad2(t.getHours())}:${pad2(t.getMinutes())}`;};
const mins=d=>Math.max(0,Math.round((new Date(d)-Date.now())/60000));
const readLines=()=>{const raw=$("#exactFilter").value.trim(); if(!raw) return null; return raw.split(",").map(s=>s.trim().toUpperCase()).filter(Boolean);};

// Multi-strategy fetch
async function gqlSmart(query, variables){
  const tries = [];
  // 1) POST JSON with required header
  tries.push(()=>fetch(ENDPOINTS[0], {method:"POST",mode:"cors",cache:"no-store",
      headers:{"content-type":"application/json","ET-Client-Name":CLIENT},
      body:JSON.stringify({query,variables})
  }));
  // 2) POST JSON without custom header
  tries.push(()=>fetch(ENDPOINTS[0], {method:"POST",mode:"cors",cache:"no-store",
      headers:{"content-type":"application/json"},
      body:JSON.stringify({query,variables})
  }));
  // 3) GET with query params (no headers)
  tries.push(()=>{
    const u=new URL(ENDPOINTS[0]);
    u.searchParams.set("query", query.replace(/\s+/g," "));
    u.searchParams.set("variables", JSON.stringify(variables));
    return fetch(u.toString(), {method:"GET",mode:"cors",cache:"no-store"});
  });
  // 4) POST to v2 with header
  tries.push(()=>fetch(ENDPOINTS[1], {method:"POST",mode:"cors",cache:"no-store",
      headers:{"content-type":"application/json","ET-Client-Name":CLIENT},
      body:JSON.stringify({query,variables})
  }));
  // Try each in sequence
  let lastErr=""; let strategyIdx=-1;
  for (let i=0;i<tries.length;i++){
    try{
      const res = await tries[i]();
      if(!res.ok) { lastErr = "HTTP "+res.status; continue; }
      const js = await res.json();
      if(js && !js.errors){ strategyIdx=i; return { ok:true, data:js, strategy:i }; }
      lastErr = "GraphQL: "+(js.errors && js.errors[0] && js.errors[0].message || "unknown");
    }catch(e){ lastErr = e.message || "fetch failed"; }
  }
  return { ok:false, error:lastErr, strategy:strategyIdx };
}

const GQL_SP = `
query($id:ID!,$per:Int!,$range:Int!){
  stopPlace(id:$id){
    id name
    quays{
      id publicCode name
      estimatedCalls(timeRange:$range, numberOfDepartures:$per){
        expectedDepartureTime realtime aimedDepartureTime destinationDisplay{frontText}
        quay{id publicCode name}
        serviceJourney{journeyPattern{line{id publicCode name transportMode}}}
      }
    }
  }
}`;

function buildRowsFromStopPlace(sp){
  const rows=[]; const quays=sp?.quays||[];
  for(const q of quays){
    const calls=q?.estimatedCalls||[];
    for(const c of calls){
      const line=c?.serviceJourney?.journeyPattern?.line||{};
      rows.push({
        t:c?.expectedDepartureTime,
        in:mins(c?.expectedDepartureTime),
        line:(line.publicCode||line.name||"").toUpperCase(),
        dest:(c?.destinationDisplay?.frontText||"").trim(),
        stop:q?.publicCode?`Perrong ${q.publicCode}`:(q?.name||"—"),
        mode:(line.transportMode||"").toUpperCase()
      });
    }
  }
  return rows;
}

async function load(){
  $("#status").textContent="Fetching…"; $("#error").style.display="none"; $("#debug").style.display="none";
  const allRows=[]; let totalQuays=0, spCount=0; const attempts=[];
  for(const id of FALLBACK_STOP_IDS){
    const {ok,data,error,strategy} = await gqlSmart(GQL_SP,{id,per:PER_FETCH,range:RANGE_SECONDS});
    attempts.push(`${id} via S${strategy>=0?strategy+1:'X'} ${ok?'OK':('ERR '+error)}`);
    if(ok){
      const sp=data?.data?.stopPlace; if(sp){ spCount++; totalQuays+=(sp.quays||[]).length; allRows.push(...buildRowsFromStopPlace(sp)); }
    }
  }
  const showBus=$("#busToggle").checked, showTram=$("#tramToggle").checked, exact=readLines();
  let rows=allRows.filter(r=>r.t).filter(r=>(r.mode!=="TRAM"||showTram)&&(r.mode!=="BUS"||showBus));
  if(exact&&exact.length) rows=rows.filter(r=>exact.includes(r.line));
  rows.sort((a,b)=>new Date(a.t)-new Date(b.t));
  render(rows);
  $("#status").textContent="Loaded"; $("#ts").textContent=new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  $("#debug").style.display="block"; $("#debug").innerHTML=`<strong>Debug:</strong> attempts → ${attempts.join(" • ")} | stopPlaces=${spCount} | quays=${totalQuays} | rows=${rows.length}`;
}

function render(rows){
  const host=$("#rows"); host.innerHTML="";
  if(!rows.length){
    const r=document.createElement("div"); r.className="trow";
    r.innerHTML='<div class="cell">—</div><div class="cell">—</div><div class="cell"><span style="color:#6b7280">No upcoming departures</span></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>';
    host.appendChild(r); return;
  }
  for(const row of rows){
    const el=document.createElement("div"); el.className="trow";
    el.innerHTML=`<div class="cell">${fmt(row.t)}</div><div class="cell">${row.in} min</div><div class="cell"><span class="line-pill">${row.line}</span></div><div class="cell">${row.dest}</div><div class="cell">${row.stop}</div><div class="cell">${row.mode==="TRAM"?"Bybanen":"Bus"}</div>`;
    host.appendChild(el);
  }
}

document.getElementById("busToggle").addEventListener("change", load);
document.getElementById("tramToggle").addEventListener("change", load);
document.getElementById("exactFilter").addEventListener("change", load);
load(); setInterval(load, REFRESH_MS);
</script>
</body>
</html>
