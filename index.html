<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bergen busstasjon — Departures by line</title>
<style>
  :root{
    --bg:#ffffff;
    --card:#f7f8fb;
    --text:#0b1220;
    --muted:#5a6778;
    --accent:#f97316;
    --accent-weak:#fbd1a7;
    --good:#16a34a;
    --warn:#ca8a04;
    --bad:#dc2626;
    --border:#e6eaf0;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;background: var(--bg);color: var(--text);}
  .wrap{max-width:1280px;margin:40px auto;padding:0 18px}
  h1{margin:0 0 8px;font-size:clamp(24px,3vw,38px);font-weight:800;letter-spacing:.2px}
  .badge{display:inline-flex;gap:.6rem;align-items:center;background:var(--card);border:1px solid var(--border);color:var(--muted);padding:.5rem .9rem;border-radius:999px;font-size:.88rem;font-weight:600;margin-bottom:16px}
  .accent{color:var(--accent)}
  .controls{display:flex;gap:.6rem;flex-wrap:wrap;margin:10px 0 18px}
  .chip{display:inline-flex;align-items:center;gap:.56rem;background:var(--card);border:1px solid var(--border);padding:.5rem .85rem;border-radius:999px;user-select:none;cursor:pointer;font-weight:600}
  .chip input{appearance:none;width:16px;height:16px;border-radius:6px;border:2px solid var(--accent);display:inline-block}
  .chip input:checked{background:var(--accent)}
  .search{min-width:260px;flex:1 1 280px;background:#fff;border:1px solid var(--border);color:var(--text);padding:.65rem .85rem;border-radius:12px;outline:none}
  #status{color:var(--muted);font-size:.95rem;margin:8px 0}
  #hint{color:var(--muted);font-size:.9rem;margin:6px 0}
  .grid{display:grid;gap:14px}
  .group{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 8px 24px rgba(17,24,39,.06)}
  .ghead{display:flex;align-items:center;gap:10px;background:var(--card);padding:12px 16px;border-bottom:1px solid var(--border)}
  .lineTag{display:inline-flex;align-items:center;justify-content:center;font-weight:800;min-width:56px;padding:8px 12px;border-radius:10px;border:1px solid var(--accent);color:#8b3d00;background:linear-gradient(180deg,var(--accent-weak),#ffb26b)}
  .tram{background:linear-gradient(180deg,#ffe4cc,#ff9e4a);color:#7a2e00}
  .gtitle{font-weight:800}
  .rows{display:grid}
  .row{display:grid;grid-template-columns: 94px 76px 1fr 180px 110px;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px dashed var(--border)}
  .row:last-child{border-bottom:none}
  .row:hover{background:#fafbfc}
  .time{font-variant-numeric:tabular-nums}
  .mins{color:var(--muted);font-size:.92rem}
  .dest,.stop{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pill{font-size:.82rem;padding:4px 8px;border-radius:999px;background:#fff;border:1px solid var(--border);color:var(--muted)}
  .dot{width:8px;height:8px;border-radius:999px;background:var(--good);display:inline-block;margin-left:8px;box-shadow:0 0 0 3px rgba(22,163,74,.18)}
  .late{color:var(--bad)} .delay{color:var(--warn)}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 2px;color:var(--muted);font-size:.92rem;margin-top:12px}
  .error{color:var(--bad);font-weight:700}
  .debug{margin-top:10px;font-size:.88rem;color:#334155;background:#fff;border:1px dashed var(--border);border-radius:12px;padding:8px 10px}
  .debug code{background:#f3f4f6;border:1px solid var(--border);padding:1px 4px;border-radius:6px}
  @media(max-width:820px){ .row{grid-template-columns: 88px 70px 1fr 0px 100px} .row .stop{display:none}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Bergen busstasjon — <span class="accent">Departures by line</span></h1>
    <div class="badge">Bergen busstasjon • Bus + Bybanen (lines 1 & 2) • Refresh 15s</div>

    <div class="controls">
      <label class="chip"><input id="busToggle" type="checkbox" checked /> Bus</label>
      <label class="chip"><input id="tramToggle" type="checkbox" checked /> Bybanen</label>
      <input id="exactFilter" class="search" placeholder="Exact line filter (comma): e.g. 1, 2, 50E, 600" />
    </div>

    <div id="status" aria-live="polite">Loading…</div>
    <div id="hint"></div>
    <div id="debug" class="debug" style="display:none"></div>

    <div id="groups" class="grid" aria-label="Groups by line"></div>

    <div class="footer">
      <div>Source: Entur realtime • StopPlaces <code>NSR:StopPlace:30810</code> (bus) + <code>NSR:StopPlace:62356</code> (Bybanen)</div>
      <div>Last update: <span id="ts">—</span></div>
    </div>
  </div>

<script>
const ENTUR_ENDPOINTS = [
  "https://api.entur.io/journey-planner/v3/graphql",
  "https://api.entur.org/journeyplanner/2.0/index/graphql"
];
const ET_CLIENT = "bergen-board/index-v1 (+contact: you@example.com)";
const STOPPLACES = { BUS: ["NSR:StopPlace:30810","NSR:StopPlace:62129"], TRAM: ["NSR:StopPlace:62356"] };
const BUS_FALLBACK_QUAYS = ["NSR:Quay:53022","NSR:Quay:53023","NSR:Quay:53024","NSR:Quay:53025","NSR:Quay:53026","NSR:Quay:53027","NSR:Quay:53028","NSR:Quay:53029","NSR:Quay:53030","NSR:Quay:53031","NSR:Quay:53032","NSR:Quay:53034","NSR:Quay:53035","NSR:Quay:53045","NSR:Quay:100080","NSR:Quay:106982"];
const REFRESH_MS = 15000, PER_FETCH = 80, RANGE_SECONDS = 6*3600;
const $ = s => document.querySelector(s);
const pad2=n=>(n<10?"0"+n:""+n), fmtTime=d=>{const t=new Date(d); return pad2(t.getHours())+":"+pad2(t.getMinutes());};
const minutesFromNow=d=>Math.max(0,Math.round((new Date(d)-new Date())/60000));
const natSort=(a,b)=>(""+a).localeCompare(""+b,undefined,{numeric:true,sensitivity:"base"});
function readExactFilter(){const raw=$("#exactFilter").value.trim(); if(!raw) return null; return raw.split(",").map(s=>s.trim().toUpperCase()).filter(Boolean);}
const GQL_STOPPLACE=`query($id:ID!,$per:Int!,$range:Int!){ stopPlace(id:$id){ id name estimatedCalls(timeRange:$range, numberOfDepartures:$per){ expectedDepartureTime realtime aimedDepartureTime predictionInaccurate destinationDisplay{frontText} quay{id publicCode name} serviceJourney{journeyPattern{ line{id publicCode name transportMode} } } } } }`;
const GQL_STOPPLACE_QUAYS=`query($id:ID!,$per:Int!,$range:Int!){ stopPlace(id:$id){ id name quays{ id publicCode name estimatedCalls(timeRange:$range, numberOfDepartures:$per){ expectedDepartureTime realtime aimedDepartureTime predictionInaccurate destinationDisplay{frontText} quay{id publicCode name} serviceJourney{journeyPattern{ line{id publicCode name transportMode} } } } } } }`;
const GQL_QUAY=`query($id:ID!,$per:Int!,$range:Int!){ quay(id:$id){ id publicCode name estimatedCalls(timeRange:$range, numberOfDepartures:$per){ expectedDepartureTime realtime aimedDepartureTime predictionInaccurate destinationDisplay{frontText} quay{id publicCode name} serviceJourney{journeyPattern{ line{id publicCode name transportMode} } } } } }`;
async function gqlFetchAny(query, variables){
  let lastErr=null,lastJson=null;
  for(const url of ENTUR_ENDPOINTS){
    try{
      const res=await fetch(url,{method:"POST",headers:{"content-type":"application/json","ET-Client-Name":ET_CLIENT},body:JSON.stringify({query,variables})});
      const json=await res.json(); lastJson=json; if(json && !json.errors) return json; lastErr=new Error((json&&json.errors&&json.errors[0]&&json.errors[0].message)||"GraphQL error");
    }catch(e){lastErr=e;}
  }
  if(lastJson) throw new Error("All endpoints returned errors");
  throw lastErr||new Error("Unknown network error");
}
async function load(){
  const showBus=$("#busToggle").checked, showTram=$("#tramToggle").checked, exact=readExactFilter();
  $("#status").textContent="Loading…"; $("#hint").textContent=""; $("#debug").style.display="none";
  let all=[], dbg={stopPlaceCalls:0, stopPlaceQuays:0, quayFallback:0};
  async function collectFromStopPlace(id,modeTag){
    let added=0;
    try{ const r=await gqlFetchAny(GQL_STOPPLACE,{id,per:PER_FETCH,range:RANGE_SECONDS}); const calls=(r?.data?.stopPlace?.estimatedCalls)||[]; calls.forEach(c=>{all.push({call:c,mode:modeTag});added++;}); if(calls.length) dbg.stopPlaceCalls+=calls.length; if(added) return added; }catch(_){}
    try{ const r2=await gqlFetchAny(GQL_STOPPLACE_QUAYS,{id,per:PER_FETCH,range:RANGE_SECONDS}); const quays=(r2?.data?.stopPlace?.quays)||[]; for(const q of quays){ const calls=q?.estimatedCalls||[]; calls.forEach(c=>{all.push({call:c,mode:modeTag});added++;}); } if(added) dbg.stopPlaceQuays+=added; return added; }catch(_){}
    return 0;
  }
  if(showBus){
    let got=0; for(const id of STOPPLACES.BUS){ got+=await collectFromStopPlace(id,"BUS"); }
    if(got===0){
      const tasks=BUS_FALLBACK_QUAYS.map(qid=>gqlFetchAny(GQL_QUAY,{id:qid,per:PER_FETCH,range:RANGE_SECONDS}).then(json=>{const calls=(json?.data?.quay?.estimatedCalls)||[]; calls.forEach(c=>{all.push({call:c,mode:"BUS"});dbg.quayFallback++;});}).catch(()=>{}));
      await Promise.all(tasks);
    }
  }
  if(showTram){ for(const id of STOPPLACES.TRAM){ await collectFromStopPlace(id,"TRAM"); } }
  let rows=all.map(({call,mode})=>{
    const line=(call?.serviceJourney?.journeyPattern?.line)||{};
    const code=(line.publicCode||line.name||"").toUpperCase();
    const dest=call?.destinationDisplay?.frontText||"";
    const stop=call?.quay?.publicCode?("Perrong "+call.quay.publicCode):(call?.quay?.name||"—");
    const whenISO=call?.expectedDepartureTime;
    const mins=minutesFromNow(whenISO);
    const transport=(line.transportMode||(mode==="TRAM"?"tram":"bus")).toUpperCase();
    const aimed=call?.aimedDepartureTime?new Date(call.aimedDepartureTime):null;
    const expected=whenISO?new Date(whenISO):aimed;
    const delayMin=(aimed&&expected)?Math.round((expected-aimed)/60000):0;
    return {t:whenISO,inMin:mins,line:code,dest,stop,mode:transport,delayMin};
  });
  if(exact&&exact.length){ rows=rows.filter(r=>exact.includes(r.line)); }
  rows=rows.filter(r=>(r.mode!=="TRAM"||showTram)&&(r.mode!=="BUS"||showBus));
  rows=rows.filter(r=>(r.mode!=="TRAM")||r.line==="1"||r.line==="2");
  rows=rows.filter(r=>!!r.t);
  const groups=new Map(); for(const r of rows){ const key=r.line||"—"; if(!groups.has(key)) groups.set(key,[]); groups.get(key).push(r); }
  const orderedKeys=Array.from(groups.keys()).sort(natSort); for(const k of orderedKeys){ groups.get(k).sort((a,b)=>new Date(a.t)-new Date(b.t)); }
  renderGroups(orderedKeys,groups);
  $("#ts").textContent=new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"});
  $("#status").textContent="Loaded";
  $("#debug").style.display="block";
  $("#debug").innerHTML=`<div><strong>Debug:</strong> stopPlace calls=${dbg.stopPlaceCalls}, quays calls=${dbg.stopPlaceQuays}, quay-fallback added=${dbg.quayFallback}</div>`;
}
function renderGroups(keys,groups){
  const host=$("#groups");
  if(!keys.length){ host.innerHTML=`<section class="group"><div class="ghead"><span class="gtitle">No upcoming departures</span></div><div class="rows"><div class="row"><div class="time">—</div><div class="mins">—</div><div class="dest">—</div><div class="stop">—</div><div class="pill">—</div></div></div></section>`; return; }
  host.innerHTML=keys.map(code=>{
    const items=groups.get(code)||[]; const sample=items[0]||{}; const isTram=sample.mode==="TRAM";
    const rows=items.map(it=>{ const minsLabel=it.inMin===0?"Now":it.inMin+" min"; const delayCls=it.delayMin>=3?"late":(it.delayMin>0?"delay":""); return `<div class="row">
      <div class="time">${fmtTime(it.t)}</div><div class="mins ${delayCls}">${minsLabel}</div><div class="dest" title="${it.dest}">${it.dest||"—"}</div><div class="stop" title="${it.stop}">${it.stop||"—"}</div><div class="pill">${it.mode==="TRAM"?"Bybanen":"Bus"} <span class="dot" style="background:${it.inMin<=1?'var(--good)':'#9aa4ad'}"></span></div></div>`; }).join("");
    return `<section class="group" aria-label="Line ${code}"><div class="ghead"><span class="lineTag ${isTram?"tram":""}">${code}</span><span class="gtitle">${isTram?"Bybanen":"Bus"}</span><span class="mins" style="margin-left:auto">${items.length} departures</span></div><div class="rows">${rows}</div></section>`;
  }).join("");
}
$("#busToggle").addEventListener("change", load);
$("#tramToggle").addEventListener("change", load);
$("#exactFilter").addEventListener("change", load);
let timer=null; async function start(){ try{ await load(); } catch(e){ $("#status").innerHTML=`<span class="error">Error:</span> ${(e&&e.message)||"Failed to fetch"}`; } finally{ if(timer) clearInterval(timer); timer=setInterval(load, 15000); } } start();
</script>
</body>
</html>
